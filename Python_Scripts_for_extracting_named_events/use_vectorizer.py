"""
@author: alex
"""
import sklearn
import nltk
nltk.download()
import csv
import pandas as pd
from nltk.corpus import stopwords
from nltk.tokenize import word_tokenize
from nltk import PorterStemmer
from sklearn.feature_extraction.text import CountVectorizer
from sklearn.feature_extraction.text import TfidfTransformer
from sklearn.feature_extraction.text import HashingVectorizer
from sklearn.feature_extraction.text import TfidfVectorizer
from sklearn.naive_bayes import MultinomialNB
from nltk import word_tokenize          
from nltk.stem import WordNetLemmatizer
import numpy as np
from sklearn.ensemble import RandomForestClassifier
from random import shuffle
from sklearn.metrics import accuracy_score
''' import library of gaussian naive bayes model '''
from sklearn.naive_bayes import GaussianNB
''' import library for svm'''
from sklearn import svm
from sklearn.discriminant_analysis import LinearDiscriminantAnalysis
# from stemming.porter2 import stem

def createCorpus(new_df_wp_posts):
    __corpus = []
    for __index, __row in new_df_wp_posts.iterrows():
        __corpus.append(__row['summary'])
    return __corpus
    

def review_to_words(new_df_wp_posts):
    __stops = set(stopwords.words("english"))
    __s = []
    for __index, __row in new_df_wp_posts.iterrows():
        __words = list(__row['analyzed_summary'])
        __meaningful_words = [w for w in __words if not w in __stops]                 
        __s.append(" ".join(__meaningful_words))
    return(__s)    
         
    
def execute_use_vectorizer(new_df_wp_posts, __df_events):
     
    print("Creating the bag of words...\n")    
    
    __corpus = createCorpus(new_df_wp_posts)
    
    __vectorizer = CountVectorizer()
    
    __analyze = __vectorizer.build_analyzer()
    
    __s = []
    
    for index, row in new_df_wp_posts.iterrows():
        __s.append(__analyze(row['summary']))      
    
    new_df_wp_posts['analyzed_summary'] = __s
    
    __clean_summaries = review_to_words(new_df_wp_posts)    
    
    new_df_wp_posts['meaningful_words'] = __clean_summaries
    
    __df_events=__df_events.rename(columns = {'object_id':'ID'})
    
    __merged_df = pd.merge(new_df_wp_posts, __df_events, on='ID', how='inner')
    
    __new___merged_df = __merged_df[['ID','meaningful_words','name']].copy()
    
    
    __new___merged_df=__new___merged_df.rename(columns = {'ID':'postID'})
    
    # print(__new___merged_df)
    
    lst = list(__new___merged_df['meaningful_words'])
    
          
    __tokenized_text =  [word_tokenize(record) for record in lst] 
    # print(__tokenized_text)
    
    __documents = [[PorterStemmer().stem(word) for word in record] for record in __tokenized_text]
    
    # print(__documents)    
    
    __new___merged_df['meaningful_words'] = __documents
    
    # print(__new___merged_df)
        
    
    __write__new___merged_df = __new___merged_df[['postID','meaningful_words']].copy()

    __write__new___merged_df=__write__new___merged_df.rename(columns = {'meaningful_words':'summary'})
    
    print(__write__new___merged_df)
    
    __write__new___merged_df.to_csv("/home/alex/NewslinesNamedEventsPrediction/csv_tables_db/wp_term_text_only_vector.csv", index=False)
    
    
    tmp_lst = list(__new___merged_df['meaningful_words'])
    
    tmp_lst2 = [[" ".join(list)] for list in tmp_lst]
    
    
    #print(tmp_lst2)
    
    
    __new___merged_df['meaningful_words'] = pd.DataFrame(tmp_lst2)
    
    print(__new___merged_df)
    
    
    __numpy_data = __new___merged_df.as_matrix()
    
    __num_rows, __num_cols = __numpy_data.shape
    
    __split_point = int( __num_rows * 3/4)
    
    __train = __numpy_data[:__split_point]
    
    __test = __numpy_data[__split_point:]
        
    __test__clean_summaries = __test[:,1] 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
    __clean_summaries =  __train[:,1]
    
    # Initialize the "CountVectorizer" object, which is scikit-learn's bag of words tool. 
    __count_vectorizer2 = CountVectorizer(analyzer = "word", tokenizer = None, preprocessor = None, stop_words = None, max_features = 5000)
    __tfidf_vectorizer2 = TfidfVectorizer()    
    
    # fit_transform() does two functions: First, it fits the model and learns the vocabulary; second, it transforms our training data into feature vectors. The input to fit_transform should be a list of strings. 
    __data_features_count_vectorizer2 = __count_vectorizer2.fit_transform(__clean_summaries)
    __data_features_tfidf_vectorizer2 = __tfidf_vectorizer2.fit_transform(__clean_summaries)
    
    # convert the result to an  array
    __data_features_count_vectorizer2 = __data_features_count_vectorizer2.toarray()
    __data_features_tfidf_vectorizer2 = __data_features_tfidf_vectorizer2.toarray()  
    
    #==================================================================================================================================================#
    
    #print(__data_features.shape)

    # Now that the Bag of Words model is trained, let's look at the vocabulary. Take a look at the words in the vocabulary.
    #__vocab_count_vectorizer2 = __data_features_count_vectorizer2.get_feature_names()
    #__vocab_tfidf_vectorizer2 = __data_features_tfidf_vectorizer2.get_feature_names()
    # print(__vocab)


    # print the counts of each word in the vocabulary  Sum up the counts of each vocabulary word 
    #__dist_count_vectorizer2 = np.sum(__data_features_count_vectorizer2, axis=0)
    #__dist_tfidf_vectorizer2 = np.sum(__data_features_tfidf_vectorizer2, axis=0)
    
    #for __tag, __count in zip(__vocab_tfidf_vectorizer2, __dist_tfidf_vectorizer2):
    #    print(__count, __tag)    
    
    #==================================================================================================================================================#
    
    print("Training the random forest...")
    print("Training the gaussian naive bayes...")
    print("Training the linear discriminant analysis...")
    print("Training the svm...")
    
    # Initialize a Random Forest classifier with 100 trees
    __forest_count_vectorizer2  = RandomForestClassifier(n_estimators = 100) 
    __forest_tfidf_vectorizer2  = RandomForestClassifier(n_estimators = 100)

    #Create a Gaussian Classifier
    __model_count_vectorizer2 = GaussianNB()
    __model_tfidf_vectorizer2 = GaussianNB()

    # create LDA model
    __lda_model = LinearDiscriminantAnalysis()
    
    # create the svm model
    __svm_model = svm.SVC()
    

    #==================================================================================================================================================#
    
    #  Fit the forest to the training set, using the bag of words as features and the sentiment labels as the response variable
    __forest_count_vectorizer2 = __forest_count_vectorizer2.fit( __data_features_count_vectorizer2,__train[:,2])
    __forest_tfidf_vectorizer2 = __forest_tfidf_vectorizer2.fit( __data_features_tfidf_vectorizer2,__train[:,2])
    
    #print(__forest)         
    
    # test for random forest
    __test__data_features_count_vectorizer2 = __count_vectorizer2.transform(__test__clean_summaries)
    __test__data_features_count_vectorizer2 = __test__data_features_count_vectorizer2.toarray()
    
    #__test_data_features_count_vectorizer2 = __forest_count_vectorizer2.transform(__test__clean_summaries)   
    __test_data_features_tfidf_vectorizer2 = __tfidf_vectorizer2.transform(__test__clean_summaries)   
    __test_data_features_tfidf_vectorizer2 = __test_data_features_tfidf_vectorizer2.toarray()
    
      
    # Use the random forest to make sentiment label predictions  ## test_data_features = test_data_features.toarray
    __result_test_data_features_count_vectorizer2 = __forest_count_vectorizer2.predict(__test__data_features_count_vectorizer2)    
    
    print(__result_test_data_features_count_vectorizer2)
    
    __result__test_data_features_tfidf_vectorizer2 = __forest_tfidf_vectorizer2.predict(__test_data_features_tfidf_vectorizer2)    
    
    print(__result__test_data_features_tfidf_vectorizer2)  
      
    # Copy the results to a pandas dataframe with an "id" column and  "name" column
    __output1_cv = pd.DataFrame( data={"ID":__test[:,0], "name":__result_test_data_features_count_vectorizer2} )
    
     # Copy the results to a pandas dataframe with an "id" column and  "name" column
    __output1_tfidf = pd.DataFrame( data={"ID":__test[:,0], "name":__result__test_data_features_tfidf_vectorizer2} )

    # Use pandas to write the comma-separated output file
    __output1_cv.to_csv( "/home/alex/NewslinesNamedEventsPrediction/csv_tables_db/random_forest_output_count_vectorizer.csv", index=False, quoting=3 )  

    # Use pandas to write the comma-separated output file
    __output1_tfidf.to_csv( "/home/alex/NewslinesNamedEventsPrediction/csv_tables_db/random_forest_output_tfidf.csv", index=False, quoting=3 )  
    
    # get the accuracy
    print("The accuracy of the random forest model with CountVectorizer is : ",accuracy_score(__test[:,2], __result_test_data_features_count_vectorizer2))
    
    # get the accuracy
    print("The accuracy of the random forest model with TfidfVectorizer is : ",accuracy_score(__test[:,2], __result__test_data_features_tfidf_vectorizer2))
    
    #=====================================================================================================================================================#    
    # try the baysian model classifier - Train the model using the training sets 
    __model_count_vectorizer2.fit(__data_features_count_vectorizer2,__train[:,2])
    __model_tfidf_vectorizer2.fit(__data_features_tfidf_vectorizer2,__train[:,2]) 
    
    __test_data_nbm_features_count_vectorizer2 = __count_vectorizer2.transform(__test__clean_summaries)   
    __test_data_nbm_features_count_vectorizer2 = __test_data_nbm_features_count_vectorizer2.toarray()
    
    __test_data_nbm_features_tfidf_vectorizer2 = __tfidf_vectorizer2.transform(__test__clean_summaries)   
    __test_data_nbm_features_tfidf_vectorizer2 = __test_data_nbm_features_tfidf_vectorizer2.toarray()
    
    #Predict Output 
    __predicted_count_vectorizer = __model_count_vectorizer2.predict(__test_data_nbm_features_count_vectorizer2)
    __predicted_tfidf = __model_tfidf_vectorizer2.predict(__test_data_nbm_features_tfidf_vectorizer2)  
    
    # Copy the results to a pandas dataframe with an "id" column and  "name" column
    __output2_cv = pd.DataFrame( data={"ID":__test[:,0], "name":__predicted_count_vectorizer} )
    __output2_tfidf = pd.DataFrame( data={"ID":__test[:,0], "name":__predicted_tfidf} )
    
    __output2_cv.to_csv( "/home/alex/NewslinesNamedEventsPrediction/csv_tables_db/gaussian_naive_bayes_count_vectorizer.csv", index=False, quoting=3 )
    
    __output2_tfidf.to_csv( "/home/alex/NewslinesNamedEventsPrediction/csv_tables_db/gaussian_naive_bayes_tfidf.csv", index=False, quoting=3 )
    
    print(__predicted_count_vectorizer)
    print(__predicted_tfidf)
    
    
    print("The accuracy of the gaussian naive bayes model with CountVectorizer is : ",accuracy_score(__test[:,2],__predicted_count_vectorizer))
    print("The accuracy of the gaussian naive bayes model with TfidfVectorizer is : ",accuracy_score(__test[:,2],__predicted_tfidf))
    #==================================================================================================================================================#
    
    __lda_model.fit(__data_features_count_vectorizer2,__train[:,2])
    
    __test_data_lda_features_count_vectorizer2 = __count_vectorizer2.transform(__test__clean_summaries)    
    
    __test_data_lda_features_count_vectorizer2 = __test_data_lda_features_count_vectorizer2.toarray()
    
    __predicted_lda = __lda_model.predict(__test_data_lda_features_count_vectorizer2)
    
    print(__predicted_lda)
   
    print("The accuracy of the linear discriminant analysis model  with the CountVectorizer is : ",accuracy_score(__test[:,2],__predicted_lda))

    __output3 = pd.DataFrame( data={"ID":__test[:,0], "name":__predicted_lda} )
    
    __output3.to_csv("/home/alex/NewslinesNamedEventsPrediction/csv_tables_db/linear_discriminant_analysis_count_vectorizer.csv", index=False, quoting=3)
    
    #=================================================================================================================================================#
    # train the svm model 
    __svm_model.fit(__data_features_count_vectorizer2,__train[:,2])
    
    __test_data_svm_features = __count_vectorizer2.transform(__test__clean_summaries)   
    
    __test_data_svm_features = __test_data_svm_features.toarray()
    
    __predicted_svm  = __svm_model.predict(__test_data_svm_features)
    
    # Copy the results to a pandas dataframe with an "id" column and  "name" column
    __output4 = pd.DataFrame( data={"ID":__test[:,0], "name":__predicted_svm} )
    
    __output4.to_csv( "/home/alex/NewslinesNamedEventsPrediction/csv_tables_db/svm_count_vectorizer.csv", index=False, quoting=3 )
    
    print(__predicted_svm)
    
    print("The accuracy of the svm model with the CountVectorizer is : ",accuracy_score(__test[:,2],__predicted_svm)) 
    
    return 0